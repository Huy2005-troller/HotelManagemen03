@model HotelManagement.ViewModels.LoaiPhongPhongTrangThaiPhong
@inject IHttpContextAccessor accessor

<div class="container-fluid py-4">
    <div class="row">

        @* Hiển thị thông báo lỗi *@
        @{
            if (Model.error == false)
            {
                <div class="col-12 mb-4">
                    <div class="alert alert-danger text-center shadow-sm" role="alert">
                        <strong>Lỗi:</strong> Bạn chưa nhập đủ thông tin.
                    </div>
                </div>
            }
        }

        @* Thanh bên: Lọc theo Loại phòng và Trạng thái phòng *@
        <div class="col-md-3">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white text-center py-3 rounded-top">
                    <h5 class="mb-0 fw-bold">Loại phòng <i class="bi bi-arrow-down-short"></i></h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush text-center">
                        <a class="list-group-item list-group-item-action py-3 fw-bold" href="/room/index">Tất cả</a>
                        @foreach (var loaiphong in Model.loaiphongs)
                        {
                            <a class="list-group-item list-group-item-action py-2"
                               asp-action="Index" asp-route-loaiphong="@loaiphong.MaLoaiPhong">@loaiphong.TenLoaiPhong</a>
                        }
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white text-center py-3 rounded-top">
                    <h5 class="mb-0 fw-bold">Trạng thái phòng <i class="bi bi-arrow-down-short"></i></h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush text-center">
                        @foreach (var trangthai in Model.trangthaiphongs)
                        {
                            <a class="list-group-item list-group-item-action py-2"
                               asp-action="Index" asp-route-trangthaiphong="@trangthai.MaTrangThai">@trangthai.TenTrangThai</a>
                        }
                    </div>
                </div>
            </div>
        </div>

        @* Khu vực hiển thị phòng và tìm kiếm *@
        <div class="col-md-9">
            <div class="d-flex mb-4">
                <form method="get" asp-action="Index" class="d-flex w-100">
                    <input type="text" name="tenphong" class="form-control form-control-lg me-2" placeholder="Tìm kiếm tên phòng..." value="@Context.Request.Query["tenphong"]" />
                    <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                </form>
            </div>

            @* Danh sách phòng *@
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" style="max-height: 700px; overflow-y: auto;">
                @foreach (var phong in Model.phongs)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm border-0 room-card">
                            <div class="card h-100 shadow-sm border-0 room-card">
                                <!-- Phần hình ảnh sử dụng ratio -->
                                <div class="ratio ratio-16x9">
                                    @{
                                        if (phong.MaLoaiPhongNavigation.MaLoaiPhong == "MLP1")
                                        {
                                            <img src="~/pictures/DonGiaRejpg.jpg" class="card-img-top" style="object-fit: cover;" alt="Loại phòng MLP1">
                                        }
                                        else if (phong.MaLoaiPhongNavigation.MaLoaiPhong == "MLP2")
                                        {
                                            <img src="~/pictures/DoiGiaRe.jpg" class="card-img-top" style="object-fit: cover;" alt="Loại phòng MLP2">
                                        }
                                        else if (phong.MaLoaiPhongNavigation.MaLoaiPhong == "MLP3")
                                        {
                                            <img src="~/pictures/phongGiaDinh1.jpg" class="card-img-top" style="object-fit: cover;" alt="Loại phòng MLP3">
                                        }
                                        else if (phong.MaLoaiPhongNavigation.MaLoaiPhong == "MLP4")
                                        {
                                            <img src="~/pictures/phongDoiVip.jpg" class="card-img-top" style="object-fit: cover;" alt="Loại phòng MLP4">
                                        }
                                        else
                                        {
                                            <img src="~/pictures/phongDonVip.jpg" class="card-img-top" style="object-fit: cover;" alt="Loại phòng khác">
                                        }
                                    }
                                </div>

                                <!-- Phần nội dung thẻ card -->
                               
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title text-primary">
                                    @phong.TenPhong -
                                    <span class="badge @(phong.MaTrangThaiNavigation.MaTrangThai == "MTT1" ? "bg-success" :
                        phong.MaTrangThaiNavigation.MaTrangThai == "MTT2" ? "bg-warning text-dark" :
                        "bg-secondary")">
                                        @phong.MaTrangThaiNavigation.TenTrangThai
                                    </span>
                                </h5>
                                <p class="card-text text-muted mb-3">
                                    @phong.MaLoaiPhongNavigation.TenLoaiPhong - <strong>@String.Format("{0:N0}", phong.MaLoaiPhongNavigation.GiaPhong) VNĐ</strong>
                                </p>

                                <div class="mt-auto">
                                    @{
                                        if (phong.MaTrangThaiNavigation.MaTrangThai == "MTT1") // Phòng trống
                                        {
                                            if (accessor.HttpContext.Session.GetString("UserName") != null) // Nếu là khách hàng
                                            {
                                                <button type="button" class="btn btn-primary w-100 open-checkin-modal" data-maphong="@phong.MaPhong">
                                                    Đặt trước
                                                </button>
                                            }
                                            else // Nếu là admin hoặc nhân viên
                                            {
                                                <button type="button" class="btn btn-success w-100 open-checkin-modal" data-maphong="@phong.MaPhong">
                                                    Đặt phòng
                                                </button>
                                            }

                                            // Modal Đặt phòng (MTT1)
                                            <div class="modal fade" id="modal-@phong.MaPhong" tabindex="-1" aria-labelledby="modalLabel-@phong.MaPhong" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                                                <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                                                    <div class="modal-content">
                                                        <div class="modal-header bg-success text-white">
                                                            <h5 class="modal-title" id="modalLabel-@phong.MaPhong">
                                                                CHECKIN-CHECKOUT - @phong.MaLoaiPhongNavigation.TenLoaiPhong - @phong.TenPhong - @String.Format("{0:N0}", phong.MaLoaiPhongNavigation.GiaPhong) VNĐ
                                                            </h5>
                                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form method="post" asp-controller="Room" asp-action="datPhongVaDichVu" id="form-@phong.MaPhong" class="row g-4">
                                                                <input class="tienPhong" type="hidden" value="@phong.MaLoaiPhongNavigation.GiaPhong">

                                                                @* Thông tin khách hàng và ngày thuê *@
                                                                <div class="col-md-6 border rounded p-4 bg-light">
                                                                    <h6 class="text-center text-primary mb-4 fw-bold">Thông tin khách hàng và Đặt phòng</h6>

                                                                    @if (accessor.HttpContext.Session.GetString("UserName") != null) // Nếu là khách hàng
                                                                    {
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Họ và tên:</label>
                                                                            <input class="form-control" name="hoten" value="@Model.Person.HoTen" disabled />
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Tuổi:</label>
                                                                            <input class="form-control" type="number" name="tuoi" value="@Model.Person.Tuoi" disabled />
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Giới tính:</label>
                                                                            <select class="form-select" name="gioitinh" disabled>
                                                                                <option value="0" selected="@Equals(Model.Person.GioiTinh,0)">Nam</option>
                                                                                <option value="1" selected="@Equals(Model.Person.GioiTinh,1)">Nữ</option>
                                                                            </select>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">CCCD:</label>
                                                                            <input class="form-control" name="cccd" value="@Model.Person.PersonId" disabled>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">SĐT:</label>
                                                                            <input class="form-control" name="sdt" value="@Model.Person.Sdt" disabled>
                                                                        </div>
                                                                    }
                                                                    else // Nếu là admin hoặc nhân viên
                                                                    {
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Họ và tên:</label>
                                                                            <input class="form-control" name="hoten" />
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Tuổi:</label>
                                                                            <input class="form-control" type="number" name="tuoi" />
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Giới tính:</label>
                                                                            <select class="form-select" name="gioitinh">
                                                                                <option value="0">Nam</option>
                                                                                <option value="1">Nữ</option>
                                                                            </select>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">CCCD:</label>
                                                                            <input class="form-control" name="cccd">
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">SĐT:</label>
                                                                            <input class="form-control" name="sdt">
                                                                        </div>
                                                                    }

                                                                    <hr />
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Ngày đến:</label>
                                                                        <input class="form-control dayIn" type="date" name="ngayden">
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Ngày đi:</label>
                                                                        <input class="form-control dayOut" type="date" name="ngaydi">
                                                                    </div>

                                                                    <input type="hidden" value="@phong.MaPhong" name="maphong">

                                                                    <div class="totalDays fw-bold text-success mt-3">Tổng ngày thuê: </div>
                                                                    <div class="tongTienPhong fw-bold text-success mt-1">Tổng tiền phòng: </div>
                                                                    <div class="room-desc text-secondary mt-2 mb-2" style="white-space: pre-line;">
                                                                        <i class="bi bi-info-circle"></i> @phong.MoTaPhong
                                                                    </div>

                                                                </div>

                                                                @* Dịch vụ *@
                                                                <div class="col-md-6 border rounded p-4 bg-light">
                                                                    <h6 class="text-center text-primary mb-4 fw-bold">Dịch vụ</h6>
                                                                    <div class="service-scroll mb-3">
                                                                        <table class="table table-bordered table-hover" id="dichVuTable">
                                                                            <thead class="table-light">
                                                                                <tr>
                                                                                    <th>Chọn</th>
                                                                                    <th>Tên DV</th>
                                                                                    <th>Giá DV</th>
                                                                                    <th>SL</th>
                                                                                    <th>Tổng tiền</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                @{
                                                                                    foreach (var dichvu in Model.dichvus)
                                                                                    {
                                                                                        <tr>
                                                                                            <td class="align-middle text-center">
                                                                                                <input type="checkbox" class="form-check-input checkbox" data-gia="@dichvu.GiaDichVu">
                                                                                            </td>
                                                                                            <td class="madichvu align-middle" data-madichvu="@dichvu.MaDichVu">@dichvu.TenDichVu</td>
                                                                                            <td class="align-middle">@String.Format("{0:N0}", dichvu.GiaDichVu)</td>
                                                                                            <td class="align-middle">
                                                                                                <input style="width: 60px;" class="form-control form-control-sm quantity" type="number" min="0" value="0" data-gia="@dichvu.GiaDichVu" />
                                                                                            </td>
                                                                                            <td class="total align-middle text-end fw-bold">0</td>
                                                                                        </tr>
                                                                                    }
                                                                                }
                                                                            </tbody>
                                                                        </table>
                                                                    </div>

                                                                    <input type="hidden" id="selectedServiceIds" name="selectedServiceIds" />
                                                                    <input type="hidden" id="servicePrice" name="servicePrice" />
                                                                    <input type="hidden" id="selectedQuantities" name="selectedQuantities" />

                                                                    <div class="tongTien fw-bold text-success mt-3">Tổng tiền dịch vụ: 0</div>
                                                                    <div class="totalAll fw-bold text-danger mt-1 fs-5">Tổng tất cả: </div>
                                                                </div>
                                                            </form>
                                                        </div>

                                                        <div class="modal-footer d-flex justify-content-between">
                                                            <button type="button" class="btn btn-secondary close-modal-btn" data-bs-dismiss="modal">Đóng</button>
                                                            <button type="button" class="btn btn-primary submit-form-btn" data-form-id="form-@phong.MaPhong">Xác nhận Đặt phòng</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        else if (phong.MaTrangThaiNavigation.MaTrangThai == "MTT2") // Đang thuê
                                        {
                                            if (accessor.HttpContext.Session.GetString("UserName") == null && accessor.HttpContext.Session.GetString("admin") == null && accessor.HttpContext.Session.GetString("nhanvien") == null)
                                            {
                                                // Không hiển thị gì
                                            }
                                            else if (accessor.HttpContext.Session.GetString("admin") != null || accessor.HttpContext.Session.GetString("nhanvien") != null) // Admin/Nhân viên
                                            {
                                                <a class="btn btn-warning w-100" asp-controller="Room" asp-action="thanhToan" asp-route-maphong="@phong.MaPhong">Thanh toán</a>
                                            }
                                            else if (accessor.HttpContext.Session.GetString("UserName") != null) // Khách hàng
                                            {
                                                <button class="btn btn-secondary w-100" disabled>Đang thuê</button>
                                            }
                                        }
                                        else if (phong.MaTrangThaiNavigation.MaTrangThai == "MTT3") // Đặt trước
                                        {
                                            if (accessor.HttpContext.Session.GetString("UserName") == null && (accessor.HttpContext.Session.GetString("admin") != null || accessor.HttpContext.Session.GetString("nhanvien") != null))
                                            {
                                                <button type="button" class="btn btn-info w-100 open-confirm-modal" data-maphong="@phong.MaPhong">
                                                    Xác nhận
                                                </button>

                        // Modal Xác nhận (MTT3)
                                                <div class="modal fade" id="modal-@phong.MaPhong" tabindex="-1" aria-labelledby="confirmModalLabel-@phong.MaPhong" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                                                    <div class="modal-dialog modal-xl modal-dialog-centered">
                                                        <div class="modal-content">
                                                            <div class="modal-header bg-info text-white">
                                                                <h5 class="modal-title" id="confirmModalLabel-@phong.MaPhong">Xác nhận Đặt trước</h5>
                                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body row g-4">
                                                                <form method="post" class="w-100">
                                                                    <div class="col-md-6 border rounded p-4 bg-light">
                                                                        <h6 class="text-center text-primary mb-4 fw-bold">Thông tin khách hàng</h6>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Họ và tên:</label>
                                                                            <input class="form-control" value="@phong.OrderPhongs.FirstOrDefault().Person.HoTen" disabled>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Tuổi:</label>
                                                                            <input class="form-control" value="@phong.OrderPhongs.FirstOrDefault().Person.Tuoi" type="number" disabled>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Giới tính:</label>
                                                                            <select class="form-select" disabled>
                                                                                <option value="0" selected="@Equals(phong.OrderPhongs.FirstOrDefault().Person.GioiTinh,0)">Nam</option>
                                                                                <option value="1" selected="@Equals(phong.OrderPhongs.FirstOrDefault().Person.GioiTinh,1)">Nữ</option>
                                                                            </select>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">CCCD:</label>
                                                                            <input disabled class="form-control" value="@phong.OrderPhongs.FirstOrDefault().Person.PersonId">
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">SĐT:</label>
                                                                            <input disabled class="form-control" value="@phong.OrderPhongs.FirstOrDefault().Person.Sdt">
                                                                        </div>

                                                                        <hr />

                                                                        <label>Ngày đến</label>
                                                                        <div>@phong.OrderPhongs.FirstOrDefault().NgayDen.ToString()</div>

                                                                        <label>Ngày đi</label>
                                                                        <div>@phong.OrderPhongs.FirstOrDefault().NgayDi</div>
                                                                    </div>

                                                                    <div class="col-md-6 border rounded p-4 bg-light">
                                                                        <h6 class="text-center text-primary mb-4 fw-bold">Dịch vụ đã đặt</h6>
                                                                        <div class="table-responsive">
                                                                            <table class="table table-bordered table-striped">
                                                                                <thead class="table-light">
                                                                                    <tr>
                                                                                        <th>#</th>
                                                                                        <th>Tên Dịch vụ</th>
                                                                                        <th>Giá</th>
                                                                                        <th>Số lượng</th>
                                                                                        <th>Tổng tiền</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                                                    @{
                                                                                        int i = 1;
                                                                                        foreach (var dichvu in phong.OrderPhongs.FirstOrDefault().OrderPhongDichVus)
                                                                                        {
                                                                                            <tr>
                                                                                                <td>@(i++)</td>
                                                                                                <td>@dichvu.MaDichVuNavigation.TenDichVu</td>
                                                                                                <td>@String.Format("{0:N0}", @dichvu.DonGia)</td>
                                                                                                <td>@dichvu.SoLuong</td>
                                                                                                <td>@String.Format("{0:N0}", (dichvu.DonGia * dichvu.SoLuong))</td>
                                                                                            </tr>
                                                                                        }
                                                                                    }
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </form>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary close-modal-btn" data-bs-dismiss="modal">Đóng</button>
                                                                <a class="btn btn-success" asp-controller="Room" asp-action="xacNhanDatPhong" asp-route-maphong="@phong.MaPhong">Xác nhận Checkin</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>@await Html.PartialAsync("footer")

@section Scripts {
    <script>
        // Xử lý mở modal
        document.querySelectorAll('.open-checkin-modal, .open-confirm-modal').forEach(btn => {
            btn.addEventListener('click', function () {
                const maphong = this.getAttribute('data-maphong');
                const modal = new bootstrap.Modal(document.getElementById(`modal-${maphong}`));
                modal.show();
            });
        });

        // Xử lý đóng modal
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const modal = this.closest('.modal');
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
            });
        });

        // Xử lý submit form
        document.querySelectorAll('.submit-form-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const formId = this.getAttribute('data-form-id');
                document.getElementById(formId).submit();
            });
        });

        // Tính toán ngày và tiền phòng
        function tinhNgay(input) {
            const container = input.closest('.modal-body');
            const ngayDen = container.querySelector('.dayIn').value;
            const ngayDi = container.querySelector('.dayOut').value;

            if (ngayDen && ngayDi) {
                const startDate = new Date(ngayDen);
                const endDate = new Date(ngayDi);
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                const giaPhong = parseFloat(container.querySelector('.tienPhong').value);
                const tongTienPhong = diffDays * giaPhong;

                container.querySelector('.totalDays').textContent = `Tổng ngày thuê: ${diffDays}`;
                container.querySelector('.tongTienPhong').textContent = `Tổng tiền phòng: ${tongTienPhong.toLocaleString()} VNĐ`;

                updateTotalAll(container);
            }
        }

        // Cập nhật tổng tiền dịch vụ
        function updateTotal(input) {
            const row = input.closest('tr');
            const gia = parseFloat(row.querySelector('.quantity').getAttribute('data-gia'));
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const total = gia * quantity;

            row.querySelector('.total').textContent = total.toLocaleString();

            const container = input.closest('.modal-body');
            updateServiceTotal(container);
            updateTotalAll(container);
        }

        // Cập nhật tổng tiền dịch vụ
        function updateServiceTotal(container) {
            let totalService = 0;
            const serviceIds = [];
            const servicePrices = [];
            const quantities = [];

            container.querySelectorAll('tr').forEach(row => {
                const checkbox = row.querySelector('.checkbox');
                if (checkbox && checkbox.checked) {
                    const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                    const gia = parseFloat(row.querySelector('.quantity').getAttribute('data-gia'));
                    totalService += gia * quantity;

                    serviceIds.push(row.querySelector('.madichvu').getAttribute('data-madichvu'));
                    servicePrices.push(gia);
                    quantities.push(quantity);
                }
            });

            container.querySelector('.tongTien').textContent = `Tổng tiền dịch vụ: ${totalService.toLocaleString()}`;

            container.querySelector('#selectedServiceIds').value = serviceIds.join(',');
            container.querySelector('#servicePrice').value = servicePrices.join(',');
            container.querySelector('#selectedQuantities').value = quantities.join(',');
        }

        // Cập nhật tổng tất cả
        function updateTotalAll(container) {
            const tongTienPhongText = container.querySelector('.tongTienPhong').textContent;
            const tongTienDichVuText = container.querySelector('.tongTien').textContent;

            const tongTienPhong = parseFloat(tongTienPhongText.replace(/[^0-9]/g, '')) || 0;
            const tongTienDichVu = parseFloat(tongTienDichVuText.replace(/[^0-9]/g, '')) || 0;
            const tongTien = tongTienPhong + tongTienDichVu;

            container.querySelector('.totalAll').textContent = `Tổng tất cả: ${tongTien.toLocaleString()} VNĐ`;
        }

        // Gán sự kiện cho các input
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.dayIn, .dayOut').forEach(input => {
                input.addEventListener('input', function () {
                    tinhNgay(this);
                });
            });

            document.querySelectorAll('.checkbox, .quantity').forEach(input => {
                input.addEventListener('change', function () {
                    updateTotal(this);
                });
                input.addEventListener('input', function () {
                    updateTotal(this);
                });
            });
        });
    </script>
}

@section Styles {
    <style>
        .service-scroll {
            max-height: 250px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            background: #fff;
        }
        .room-desc {
            font-size: 1rem;
            color: #555;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #e9ecef;
        }
    </style>
}
